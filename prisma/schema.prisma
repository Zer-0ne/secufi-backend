generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Model with Family Management
// ============================================================================

model User {
  id       String  @id @default(uuid()) @db.Uuid
  name     String?
  email    String? @unique
  role     String? @default("user")
  password String?

  // OTP Authentication Fields
  otp            String?   @db.VarChar(6)
  otp_expires_at DateTime?

  // User Type
  user_type String? @default("parent") @db.VarChar(20)

  // Google OAuth fields
  google_id       String?   @unique
  google_email    String?
  profile_picture String?   @db.Text
  is_google_user  Boolean   @default(false)
  is_verified     Boolean   @default(false)
  is_active       Boolean   @default(true)
  last_login      DateTime?

  // Contact Information
  phone         String?
  address       String?   @db.Text
  date_of_birth DateTime?

  // Financial information
  pan_number       String? @unique @db.VarChar(10)
  aadhar_number    String? @unique @db.VarChar(12)
  gstin            String? @unique @db.VarChar(15)
  asset_preference Json?   @default("{}")
  customer_id      String? @db.VarChar(50)
  account_number   String? @db.VarChar(50)
  crn_number       String?
  pran_number      String?
  uan_number       String?

  // Family Relations
  family_memberships FamilyMember[] @relation("UserFamilies")

  // Family Ownership (if this user is the family head/owner)
  owned_family Family? @relation("FamilyOwner")

  // Family Invitations - Explicit relation names
  invitations_sent     FamilyInvitation[] @relation("InvitedBy")
  invitations_received FamilyInvitation[] @relation("InvitedUser")

  will Will? // One-to-one relation to Will

  // Audit fields
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // processing date details
  expire_email_processing DateTime?
  expire_sms_processing   DateTime?

  // Relations
  transactions            Transaction[]
  pdf_documents           PdfDocument[]
  documents               Document[]
  sessions                Session[]
  assets                  Asset[]
  google_credentials      GoogleCredential?
  family_access_as_parent FamilyAccess[]    @relation("ParentUser")
  family_access_as_family FamilyAccess[]    @relation("FamilyUser")
  activity_logs           ActivityLog[]
  assetsSharedByMe        SharedAsset[]     @relation("SharedByUser")
  assetsSharedWithMe      SharedAsset[]     @relation("SharedWithUser")

  @@index([email])
  @@index([phone])
  @@index([google_id])
  @@index([is_active])
  @@index([role])
  @@index([user_type])
  @@index([otp_expires_at])
  @@map("users")
}

// ============================================================================
// Family Model - Represents a family group
// ============================================================================

model Family {
  id String @id @default(uuid()) @db.Uuid

  // Basic Info
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Owner/Admin - Add @unique constraint
  owner_id String @unique @db.Uuid
  owner    User   @relation("FamilyOwner", fields: [owner_id], references: [id], onDelete: Cascade)

  // Members
  members FamilyMember[] @relation("FamilyMembers")

  // Settings
  settings FamilySettings?

  // Roles & Permissions
  roles FamilyRole[]

  // Member requests/invitations
  invitations FamilyInvitation[]

  // Audit
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  sharedAssets SharedAsset[]

  @@index([owner_id])
  @@index([name])
  @@map("families")
}

// Add this new model
model FamilyMember {
  id String @id @default(uuid()) @db.Uuid

  family_id String @db.Uuid
  family    Family @relation("FamilyMembers", fields: [family_id], references: [id], onDelete: Cascade)

  user_id String @db.Uuid
  user    User   @relation("UserFamilies", fields: [user_id], references: [id], onDelete: Cascade)

  // Role in this specific family
  role String @db.VarChar(20) // "owner", "admin", "member", "viewer"

  // Permissions for this membership
  can_view   Boolean @default(true)
  can_edit   Boolean @default(false)
  can_delete Boolean @default(false)
  can_invite Boolean @default(false)

  // Membership status
  is_active  Boolean  @default(true)
  joined_at  DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([family_id, user_id])
  @@index([family_id])
  @@index([user_id])
  @@index([role])
  @@map("family_members")
}

// ============================================================================
// Family Invitation Model - WITH EXPLICIT RELATION NAMES
// ============================================================================

model FamilyInvitation {
  id String @id @default(uuid()) @db.Uuid

  // Invitation Details
  family_id String @db.Uuid
  family    Family @relation(fields: [family_id], references: [id], onDelete: Cascade)

  // User who sent the invitation
  invited_by_id String @db.Uuid
  invited_by    User   @relation("InvitedBy", fields: [invited_by_id], references: [id], onDelete: Cascade)

  // Invitee info (User who received the invitation)
  invited_email   String  @db.VarChar(255)
  invited_user_id String? @db.Uuid
  invited_user    User?   @relation("InvitedUser", fields: [invited_user_id], references: [id], onDelete: SetNull)

  // Invitation Status
  status String @default("pending") @db.VarChar(20) // "pending", "accepted", "rejected", "expired"
  role   String @default("member") @db.VarChar(20)

  // Expiration
  expires_at  DateTime?
  accepted_at DateTime?
  rejected_at DateTime?

  // Audit
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([family_id, invited_email])
  @@index([family_id])
  @@index([invited_by_id])
  @@index([invited_user_id])
  @@index([invited_email])
  @@index([status])
  @@map("family_invitations")
}

// ============================================================================
// Family Settings Model
// ============================================================================

model FamilySettings {
  id String @id @default(uuid()) @db.Uuid

  family_id String @unique @db.Uuid
  family    Family @relation(fields: [family_id], references: [id], onDelete: Cascade)

  // Privacy Settings
  can_share_assets Boolean @default(true)
  can_view_others  Boolean @default(true)
  require_approval Boolean @default(false)

  // Financial Settings
  currency             String @default("INR") @db.VarChar(10)
  financial_year_start String @default("01-04") // Format: MM-DD

  // Notifications
  notify_large_transactions   Boolean @default(true)
  large_transaction_threshold Float   @default(100000)

  // Metadata
  data Json? @default("{}")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([family_id])
  @@map("family_settings")
}

// ============================================================================
// Family Role Model - Define roles and permissions
// ============================================================================

model FamilyRole {
  id String @id @default(uuid()) @db.Uuid

  family_id String @db.Uuid
  family    Family @relation(fields: [family_id], references: [id], onDelete: Cascade)

  // Role Details
  name        String  @db.VarChar(50) // "owner", "admin", "member", "viewer"
  description String? @db.Text

  // Permissions (stored as JSON for flexibility)
  permissions Json @default("{}")

  is_default Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([family_id, name])
  @@index([family_id])
  @@map("family_roles")
}

// ============================================================================
// Family Access Model (for tracking specific access grants)
// ============================================================================

model FamilyAccess {
  id String @id @default(uuid()) @db.Uuid

  // Parent-Child relationship
  parent_user_id String @db.Uuid
  parent_user    User   @relation("ParentUser", fields: [parent_user_id], references: [id], onDelete: Cascade)

  child_user_id String @db.Uuid
  child_user    User   @relation("FamilyUser", fields: [child_user_id], references: [id], onDelete: Cascade)

  // Access Type
  access_type String @db.VarChar(50) // "view", "edit", "full"

  // Resource Access
  can_view_assets   Boolean @default(true)
  can_edit_assets   Boolean @default(false)
  can_delete_assets Boolean @default(false)

  // Status
  is_active Boolean @default(true)

  // Restrictions
  access_until DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([parent_user_id, child_user_id])
  @@index([parent_user_id])
  @@index([child_user_id])
  @@map("family_access")
}

// ============================================================================
// Activity Log Model - Track family activities
// ============================================================================

model ActivityLog {
  id String @id @default(uuid()) @db.Uuid

  user_id String @db.Uuid
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Activity Details
  action      String  @db.VarChar(100) // "create_asset", "update_asset", "share_data", etc.
  entity_type String  @db.VarChar(50) // "asset", "transaction", "family_member"
  entity_id   String? @db.VarChar(100)

  // Change tracking
  changes    Json? @default("{}")
  old_values Json? @default("{}")
  new_values Json? @default("{}")

  // Metadata
  ip_address String? @db.VarChar(45)
  user_agent String? @db.Text

  created_at DateTime @default(now())

  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@index([entity_type])
  @@map("activity_logs")
}

// ============================================================================
// Google Credentials Model
// ============================================================================

model GoogleCredential {
  id      String @id @default(uuid()) @db.Uuid
  user_id String @unique @db.Uuid

  // Encrypted credentials (AES)
  encrypted_access_token  String @db.Text
  encrypted_refresh_token String @db.Text

  // Token expiry
  access_token_expires_at  DateTime
  refresh_token_expires_at DateTime

  // IV for AES (stored separately for decryption)
  access_token_iv  String @db.VarChar(32)
  refresh_token_iv String @db.VarChar(32)

  // Auto-expiry field (for cleanup)
  expires_at DateTime

  // Metadata
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@index([access_token_expires_at])
  @@map("google_credentials")
}

// ============================================================================
// Session Model
// ============================================================================

model Session {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  session_token String   @unique
  expires_at    DateTime
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([session_token])
  @@index([expires_at])
  @@index([user_id])
  @@map("sessions")
}

// ============================================================================
// Transaction Model
// ============================================================================

model Transaction {
  id               String            @id @default(uuid()) @db.Uuid
  user_id          String            @db.Uuid
  email_id         String
  subject          String?           @db.Text
  sender           String
  recipient        String
  amount           Decimal?          @db.Decimal(15, 2)
  currency         String?           @default("USD") @db.VarChar(3)
  transaction_type TransactionType   @default(other)
  merchant         String?
  description      String?           @db.Text
  transaction_date DateTime?
  email_date       DateTime
  status           TransactionStatus @default(pending)
  raw_data         Json?
  extracted_data   Json?
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt

  user          User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  pdf_documents PdfDocument[]

  @@index([user_id])
  @@index([email_id])
  @@index([transaction_type])
  @@index([transaction_date])
  @@index([status])
  @@index([sender])
  @@map("transactions")
}

// ============================================================================
// PDF Document Model
// ============================================================================

model PdfDocument {
  id                  String        @id @default(uuid()) @db.Uuid
  user_id             String        @db.Uuid
  transaction_id      String?       @db.Uuid
  filename            String        @db.VarChar(500)
  original_filename   String        @db.VarChar(500)
  file_path           String?       @db.Text
  file_size           BigInt
  mime_type           String        @default("application/pdf") @db.VarChar(100)
  parsing_status      ParsingStatus @default(completed)
  parsing_error       String?       @db.Text
  extracted_text      String?       @db.Text
  extracted_data      Json?
  page_count          Int?
  upload_source       UploadSource  @default(gmail)
  gmail_attachment_id String?       @db.VarChar(500)
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  user        User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transaction Transaction? @relation(fields: [transaction_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([transaction_id])
  @@index([parsing_status])
  @@index([upload_source])
  @@map("pdf_documents")
}

// ============================================================================
// Document Model
// ============================================================================

model Document {
  id                String  @id @default(uuid()) @db.Uuid
  user_id           String  @db.Uuid
  filename          String
  original_filename String
  file_path         String? @db.Text
  file_size         BigInt
  mime_type         String  @default("application/pdf")
  upload_source     String? @default("gmail")

  // File Storage Fields
  encrypted_content String? @db.Text  // Encrypted file content
  file_url          String?           // Preview URL: /api/files/preview/:id
  storage_path      String? @db.Text  // Physical file path if stored on disk

  // Parsing status and results
  parsing_status ParsingStatus @default(completed)
  parsing_error  String?       @db.Text
  extracted_text String?       @db.Text

  // AI Classification results
  document_type     DocumentType? @default(general)
  document_category String?
  confidence_score  Float?

  // Structured extracted data
  extracted_data Json?

  // Gap detection and auto-fill
  gap_detection_status GapDetectionStatus @default(pending)
  detected_gaps        Json?
  auto_fill_attempts   Json?
  auto_fill_status     AutoFillStatus     @default(pending)

  // Processing metadata
  processing_method   ProcessingMethod?
  processing_duration Int?
  ai_model_used       String?

  // Document metadata
  page_count            Int?
  is_password_protected Boolean @default(false)
  password              String? @db.Text

  // Quality and validation
  data_quality_score Float?
  validation_errors  Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([parsing_status])
  @@index([document_type])
  @@index([confidence_score])
  @@map("documents")
}

// ============================================================================
// Asset Model
// ============================================================================

model Asset {
  id      String  @id @default(uuid()) @db.Uuid
  user_id String  @db.Uuid
  name    String?

  // üéØ Main Category (3 types)
  type     String @default("Document") // 'asset' | 'liability' | 'insurance' 
  sub_type String? // Detailed type within category

  // üè¶ Bank/Financial Account Details
  account_number String? @db.VarChar(50)
  ifsc_code      String? @db.VarChar(11)
  branch_name    String? @db.VarChar(200)
  bank_name      String? @db.VarChar(200)

  // üí∞ Financial Values
  balance     Decimal? @db.Decimal(15, 2)
  total_value Decimal? @db.Decimal(15, 2) // Current value

  // üìä Status & Tracking
  status       String?  @default("inactive") // 'active' | 'inactive' | 'complete' | 'missing'
  last_updated DateTime @default(now())

  // üè¢ Address & Location
  address String? @db.Text

  crn_number String?

  // üë§ Nominee/Beneficiary Details
  nominee Json? @default("[]") // [{name, relation, percentage}]

  // üí≥ Insurance Specific Fields
  policy_number String? @db.VarChar(100)
  fund_name     String? @db.VarChar(200) // For mutual funds
  folio_number  String? @db.VarChar(100) // For mutual funds/insurance

  // üìÑ Document/Attachment Fields
  document_type     String? // "invoice", "statement", "receipt", etc.
  document_metadata Json? // Store AI analysis here
  file_name         String?
  file_size         Int?
  mime_type         String?
  file_content      String? @db.Text // Base64 content or file path

  // üîó References
  transaction_id String? @db.Uuid
  email_id       String?

  // ‚è∞ Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // issue 
  issues String[] @default([])

  // required feilds for this assests 
  required_fields String[]      @default([])
  sharedAssets    SharedAsset[]

  @@index([user_id])
  @@index([type])
  @@index([sub_type])
  @@index([status])
  @@index([transaction_id])
  @@index([account_number])
  @@index([policy_number])
  @@map("assets")
}

// ============================================================================
// Temporary User Model (for pending invitations)
// ============================================================================

model TempUser {
  id    String  @id @default(uuid()) @db.Uuid
  email String  @unique @db.VarChar(255)
  name  String? @db.VarChar(100)
  phone String? @db.VarChar(15)

  // Invitation context
  invited_by_family_id String? @db.Uuid
  invited_role         String? @db.VarChar(20) // Role they'll get when they join
  invitation_id        String? @db.Uuid // Link to FamilyInvitation

  // Metadata
  source     String    @default("family_invitation") @db.VarChar(50)
  created_at DateTime  @default(now())
  expires_at DateTime? // Auto-delete after expiry

  @@index([email])
  @@index([invited_by_family_id])
  @@index([expires_at])
  @@map("temp_users")
}

// ============================================================================
// Shared Asset Model - Track assets shared within family
// ============================================================================

model SharedAsset {
  id       String @id @default(uuid()) @db.Uuid
  asset_id String @db.Uuid
  asset    Asset  @relation(fields: [asset_id], references: [id], onDelete: Cascade)

  // Who shared this asset
  shared_by_user_id String @db.Uuid
  shared_by_user    User   @relation("SharedByUser", fields: [shared_by_user_id], references: [id], onDelete: Cascade)

  // Shared with which family
  family_id String @db.Uuid
  family    Family @relation(fields: [family_id], references: [id], onDelete: Cascade)

  // Optional: Shared with specific user (null = shared with entire family)
  shared_with_user_id String? @db.Uuid
  shared_with_user    User?   @relation("SharedWithUser", fields: [shared_with_user_id], references: [id], onDelete: Cascade)

  // Permissions for this shared asset (overrides family role permissions)
  can_view   Boolean @default(true)
  can_edit   Boolean @default(false)
  can_delete Boolean @default(false)

  // Status
  is_active Boolean @default(true)

  // Expiry (optional)
  expires_at DateTime?

  // Metadata
  notes String? @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([asset_id, family_id, shared_with_user_id])
  @@index([asset_id])
  @@index([family_id])
  @@index([shared_by_user_id])
  @@index([shared_with_user_id])
  @@index([is_active])
  @@map("shared_assets")
}

// ============================================================================
// Enums
// ============================================================================

enum TransactionType {
  payment
  receipt
  invoice
  statement
  tax
  credit_card
  bill
  other
}

enum TransactionStatus {
  pending
  processed
  failed
}

enum ParsingStatus {
  pending
  processing
  completed
  failed
}

enum UploadSource {
  gmail
  manual
  api
}

enum GapDetectionStatus {
  pending
  processing
  completed
  failed
}

enum AutoFillStatus {
  pending
  processing
  completed
  failed
  manual_review
}

enum ProcessingMethod {
  dynamicpdf
  dynamicpdf_unlocked
  dynamicpdf_unlock_failed
  pdf_parse
  pdf_lib
  pdf_lib_ignore_encryption
  pdf_lib_ignore_copy
  pdf_parse_no_password
  pdf_parse_empty_password
  ai
  regex
  hybrid
  file_storage
}

enum DocumentType {
  general
  contract
  agreement
  certificate
  license
  invoice
  receipt
  statement
  report
  letter
  form
  manual
  presentation
  spreadsheet
  other
}

// ============================================================================
// Will Builder Models
// ============================================================================

model Will {
  id String @id @default(uuid()) @db.Uuid

  // Basic Will Information
  user_id String @unique @db.Uuid
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  title       String  @default("My Last Will & Testament") @db.VarChar(200)
  description String? @db.Text
  status      WillStatus @default(draft)

  // Personal Information
  testator_name        String? @db.VarChar(100)
  testator_address     String? @db.Text
  testator_date_of_birth DateTime?
  testator_nationality String? @db.VarChar(50)
  personal_law_selection String? @db.VarChar(100)

  // Executors & Guardians
  executor_name    String? @db.VarChar(100)
  executor_address String? @db.Text
  executor_phone   String? @db.VarChar(15)
  executor_email   String? @db.VarChar(255)

  guardian_name    String? @db.VarChar(100)
  guardian_address String? @db.Text
  guardian_phone   String? @db.VarChar(15)
  guardian_email   String? @db.VarChar(255)

  // Asset Bequests
  asset_bequests Json? @default("[]") // [{asset_id, beneficiary_id, percentage, notes}]

  // Digital Assets
  digital_assets Json? @default("[]") // [{platform, username, instructions}]

  beneficiaries WillBeneficiary[]

  // Video Witness Information
  video_witness_status VideoWitnessStatus @default(pending)
  testator_video_url   String? @db.Text
  witness1_video_url   String? @db.Text
  witness2_video_url   String? @db.Text
  witness1_name        String? @db.VarChar(100)
  witness2_name        String? @db.VarChar(100)
  witness1_email       String? @db.VarChar(255)
  witness2_email       String? @db.VarChar(255)

  // Legal Information
  lawyer_name    String? @db.VarChar(100)
  lawyer_firm    String? @db.VarChar(200)
  lawyer_address String? @db.Text
  lawyer_phone   String? @db.VarChar(15)
  lawyer_email   String? @db.VarChar(255)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  signed_at  DateTime?

  // Relations
  will_sections WillSection[]

  @@index([user_id])
  @@index([status])
  @@map("wills")
}

model WillSection {
  id String @id @default(uuid()) @db.Uuid

  will_id String @db.Uuid
  will    Will   @relation(fields: [will_id], references: [id], onDelete: Cascade)

  // Section Information
  title       String  @db.VarChar(100)
  description String? @db.Text
  section_type WillSectionType
  status      WillSectionStatus @default(pending)

  // Content
  content Json? @default("{}")

  // Order and Progress
  order      Int @default(0)
  is_required Boolean @default(true)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  completed_at DateTime?

  @@unique([will_id, section_type])
  @@index([will_id])
  @@index([section_type])
  @@index([status])
  @@map("will_sections")
}

model WillBeneficiary {
  id String @id @default(uuid()) @db.Uuid

  will_id String @db.Uuid
  will    Will   @relation(fields: [will_id], references: [id], onDelete: Cascade)

  // Beneficiary Information
  name        String  @db.VarChar(100)
  relationship String? @db.VarChar(50)
  address     String? @db.Text
  phone       String? @db.VarChar(15)
  email       String? @db.VarChar(255)

  // Asset Distribution
  percentage Decimal? @db.Decimal(5, 2) // Percentage of estate
  specific_assets Json? @default("[]") // Specific assets assigned

  // Status
  is_primary Boolean @default(false)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([will_id])
  @@index([name])
  @@map("will_beneficiaries")
}

// Enums for Will Builder
enum WillStatus {
  draft
  completed
  signed
  revoked
}

enum WillSectionType {
  personal_info
  executors_guardians
  asset_bequests
  digital_assets
  video_witness
  legal_review
}

enum WillSectionStatus {
  pending
  complete
  missing
}

enum VideoWitnessStatus {
  pending
  complete
  missing
}
